name: Release
on:
  push:
    branches:
      - main
      - dev

env:
  FORCE_COLOR: true
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

permissions:
  contents: write

jobs:
  Build:
    name: Build Equicord
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web
        run: pnpm buildWebStandalone
        env:
          EQUICORD_BRANCH: ${{ github.ref_name == 'main' && 'stable' || github.ref_name }}

      - name: Build
        run: pnpm buildStandalone
        env:
          EQUICORD_BRANCH: ${{ github.ref_name == 'main' && 'stable' || github.ref_name }}

      - name: Collect files to be released
        run: |
          cd dist
          mkdir release

          cp browser/browser.* release
          cp Equicord.user.{js,js.LEGAL.txt} release
          cp *.{zip,asar} release
          cp desktop/* release

          for file in equibop/*; do
            filename=$(basename "$file")
            cp "$file" "release/equibop${filename^}"
          done

          find release -size 0 -delete

      - name: Set release tag
        id: release_tag
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "title=Latest" >> $GITHUB_OUTPUT
            echo "is_latest=true" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "title=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "is_latest=false" >> $GITHUB_OUTPUT
          fi

      - name: Update release tag
        run: |
          git tag -f ${{ steps.release_tag.outputs.tag }}
          git push -f origin ${{ steps.release_tag.outputs.tag }}

      - name: Upload to Release (latest)
        if: steps.release_tag.outputs.is_latest == 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          retry_on: error
          command: |
            gh release edit ${{ steps.release_tag.outputs.tag }} --title "${{ steps.release_tag.outputs.title }} ${{ github.sha }}" --latest
            gh release upload ${{ steps.release_tag.outputs.tag }} dist/release/* --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release (dev)
        if: steps.release_tag.outputs.is_latest == 'false'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          retry_on: error
          command: |
            gh release edit ${{ steps.release_tag.outputs.tag }} --title "${{ steps.release_tag.outputs.title }} ${{ github.sha }}" --prerelease || \
            gh release create ${{ steps.release_tag.outputs.tag }} --title "${{ steps.release_tag.outputs.title }} ${{ github.sha }}" --prerelease --notes "Development build from ${{ github.ref_name }} branch"
            gh release upload ${{ steps.release_tag.outputs.tag }} dist/release/* --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        if: success() && env.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" -d '{"content":"✅ Build successful! Release updated: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_tag.outputs.tag }}"}' $DISCORD_WEBHOOK

      - name: Notify failure
        if: failure() && env.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" -d '{"content":"<@297075664530440192> ❌ Build failed! Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' $DISCORD_WEBHOOK
